# 需求文档：录音功能

## 引言

本文档定义了 EchoFlow Pro 会议纪要系统的录音功能需求。该功能允许用户直接在浏览器中录制音频，支持选择多个音频源（系统声音和麦克风输入），录制完成后自动生成音频文件并进入现有的转录和会议纪要生成流程。

该功能将与现有的文件上传功能并存，为用户提供更灵活的音频输入方式，特别适用于实时会议录制场景。

## 需求

### 需求 1：录音按钮入口

**用户故事：** 作为一名会议参与者，我希望在主界面上看到一个明显的录音按钮，以便我可以快速开始录制会议音频。

#### 验收标准

1. WHEN 用户进入应用首页（idle状态）THEN 系统 SHALL 在文件上传区域旁边显示一个"开始录音"按钮
2. WHEN 用户点击"开始录音"按钮 THEN 系统 SHALL 显示音频源选择界面
3. IF 应用处于processing或completed状态 THEN 系统 SHALL 隐藏或禁用录音按钮
4. WHEN 录音按钮显示时 THEN 系统 SHALL 使用麦克风图标和清晰的文字标识，确保用户易于识别

### 需求 2：音频源选择

**用户故事：** 作为一名会议主持人，我希望能够选择录制系统声音和麦克风输入，以便同时捕获会议中的所有音频内容。

#### 验收标准

1. WHEN 用户点击"开始录音"按钮 THEN 系统 SHALL 弹出音频源选择对话框
2. WHEN 音频源选择对话框显示时 THEN 系统 SHALL 列出所有可用的音频输入设备（麦克风）
3. WHEN 音频源选择对话框显示时 THEN 系统 SHALL 提供"系统声音"选项（如果浏览器支持）
4. WHEN 用户选择音频源时 THEN 系统 SHALL 支持多选功能，允许同时选择多个音频源
5. WHEN 用户未选择任何音频源并尝试继续 THEN 系统 SHALL 显示错误提示"请至少选择一个音频源"
6. WHEN 用户完成音频源选择 THEN 系统 SHALL 显示"确认并开始录制"按钮
7. IF 浏览器不支持音频录制API THEN 系统 SHALL 显示友好的错误提示"您的浏览器不支持录音功能，请使用Chrome、Edge或Firefox浏览器"

### 需求 3：音频源权限请求

**用户故事：** 作为一名用户，我希望系统在需要时请求麦克风权限，以便我可以授权应用访问我的音频设备。

#### 验收标准

1. WHEN 用户选择麦克风音频源并点击"确认并开始录制" THEN 系统 SHALL 请求浏览器麦克风权限
2. WHEN 用户选择系统声音并点击"确认并开始录制" THEN 系统 SHALL 请求屏幕共享权限（用于捕获系统音频）
3. IF 用户拒绝麦克风权限 THEN 系统 SHALL 显示错误提示"麦克风权限被拒绝，无法录音"并返回音频源选择界面
4. IF 用户拒绝系统声音权限 THEN 系统 SHALL 显示错误提示"系统音频权限被拒绝"并允许用户仅使用麦克风继续
5. WHEN 权限请求成功 THEN 系统 SHALL 立即开始录音

### 需求 4：录音过程控制

**用户故事：** 作为一名会议记录员，我希望在录音过程中看到实时的录音状态和时长，以便我可以掌握录音进度。

#### 验收标准

1. WHEN 录音开始 THEN 系统 SHALL 显示录音中的界面，包含录音时长计时器
2. WHEN 录音进行中 THEN 系统 SHALL 实时更新录音时长（格式：MM:SS）
3. WHEN 录音进行中 THEN 系统 SHALL 显示音频波形或音量指示器，提供视觉反馈
4. WHEN 录音进行中 THEN 系统 SHALL 显示"停止录音"按钮，使用红色或醒目的颜色
5. WHEN 录音进行中 THEN 系统 SHALL 显示"暂停录音"按钮（可选功能）
6. WHEN 用户点击"停止录音"按钮 THEN 系统 SHALL 立即停止录音并进入音频处理流程
7. IF 录音时长超过2小时 THEN 系统 SHALL 自动停止录音并显示提示"录音时长已达上限（2小时）"
8. IF 录音时长少于5秒 AND 用户尝试停止录音 THEN 系统 SHALL 显示确认对话框"录音时长过短（少于5秒），确定要停止吗？"

### 需求 5：多音频源混音

**用户故事：** 作为一名用户，我希望系统能够自动混合多个音频源，以便生成一个包含所有声音的完整录音文件。

#### 验收标准

1. WHEN 用户选择多个音频源 THEN 系统 SHALL 在后台创建音频混音器
2. WHEN 录音进行中 AND 多个音频源被选中 THEN 系统 SHALL 实时混合所有音频流
3. WHEN 录音停止 THEN 系统 SHALL 生成单个混音后的音频文件
4. WHEN 混音处理时 THEN 系统 SHALL 自动平衡各音频源的音量，避免某个源过大或过小
5. IF 某个音频源在录音过程中断开 THEN 系统 SHALL 继续录制其他音频源并在界面上显示警告"音频源[名称]已断开"

### 需求 6：音频文件生成

**用户故事：** 作为一名用户，我希望录音完成后系统自动生成标准格式的音频文件，以便后续处理和转录。

#### 验收标准

1. WHEN 用户停止录音 THEN 系统 SHALL 将录音数据转换为音频文件
2. WHEN 生成音频文件时 THEN 系统 SHALL 使用WebM格式（浏览器原生支持）或WAV格式
3. WHEN 音频文件生成完成 THEN 系统 SHALL 自动为文件命名（格式：recording_YYYYMMDD_HHMMSS.webm）
4. WHEN 音频文件生成时 THEN 系统 SHALL 显示加载状态"正在生成音频文件..."
5. IF 音频文件生成失败 THEN 系统 SHALL 显示错误提示"音频文件生成失败，请重试"并返回首页
6. WHEN 音频文件生成成功 THEN 系统 SHALL 自动进入上传和处理流程

### 需求 7：录音文件自动处理

**用户故事：** 作为一名用户，我希望录音完成后系统自动将音频文件上传并处理，以便无缝生成会议纪要。

#### 验收标准

1. WHEN 音频文件生成成功 THEN 系统 SHALL 自动调用现有的文件上传API（/api/upload）
2. WHEN 上传录音文件时 THEN 系统 SHALL 复用现有的处理流程（上传、分片、转录、生成纪要）
3. WHEN 上传开始 THEN 系统 SHALL 将应用状态切换为'processing'
4. WHEN 处理过程中 THEN 系统 SHALL 显示与文件上传相同的进度指示器
5. WHEN 处理完成 THEN 系统 SHALL 显示生成的会议纪要结果
6. IF 上传或处理失败 THEN 系统 SHALL 提供"下载录音文件"选项，允许用户保存录音并稍后重试

### 需求 8：录音取消和错误处理

**用户故事：** 作为一名用户，我希望在录音过程中可以取消录音，并且系统能够妥善处理各种错误情况。

#### 验收标准

1. WHEN 录音进行中 AND 用户点击"取消录音"按钮 THEN 系统 SHALL 显示确认对话框"确定要取消录音吗？录音数据将丢失"
2. WHEN 用户确认取消录音 THEN 系统 SHALL 停止录音、释放音频资源并返回首页
3. IF 录音过程中发生错误（如音频设备断开） THEN 系统 SHALL 自动停止录音并显示错误提示
4. IF 浏览器内存不足 THEN 系统 SHALL 显示错误提示"内存不足，无法继续录音"并自动保存已录制的内容
5. WHEN 用户离开页面 AND 录音正在进行 THEN 系统 SHALL 显示浏览器确认对话框"录音正在进行，确定要离开吗？"
6. IF 网络断开 AND 录音完成 THEN 系统 SHALL 保存录音文件到本地，并在网络恢复后提示用户重新上传

### 需求 9：用户界面和体验

**用户故事：** 作为一名用户，我希望录音功能的界面美观、直观且易于使用，以便我可以快速上手。

#### 验收标准

1. WHEN 录音功能界面显示时 THEN 系统 SHALL 使用与现有界面一致的设计风格（颜色、字体、布局）
2. WHEN 音频源选择对话框显示时 THEN 系统 SHALL 使用模态对话框，背景半透明遮罩
3. WHEN 录音进行中 THEN 系统 SHALL 在界面中央显示大号的录音时长和波形动画
4. WHEN 录音按钮或控制按钮显示时 THEN 系统 SHALL 提供悬停效果和点击反馈
5. WHEN 任何操作进行中 THEN 系统 SHALL 禁用相关按钮，防止重复点击
6. WHEN 显示错误或警告信息时 THEN 系统 SHALL 使用与现有错误提示一致的样式
7. IF 设备屏幕较小（移动设备） THEN 系统 SHALL 调整录音界面布局，确保在小屏幕上可用

### 需求 10：浏览器兼容性

**用户故事：** 作为一名用户，我希望录音功能能够在主流浏览器上正常工作，以便我可以使用自己习惯的浏览器。

#### 验收标准

1. WHEN 应用加载时 THEN 系统 SHALL 检测浏览器是否支持MediaRecorder API
2. IF 浏览器不支持MediaRecorder API THEN 系统 SHALL 隐藏录音按钮并在帮助文档中说明
3. WHEN 录音功能在Chrome浏览器（版本90+）上使用 THEN 系统 SHALL 正常工作
4. WHEN 录音功能在Edge浏览器（版本90+）上使用 THEN 系统 SHALL 正常工作
5. WHEN 录音功能在Firefox浏览器（版本88+）上使用 THEN 系统 SHALL 正常工作
6. WHEN 录音功能在Safari浏览器（版本14+）上使用 THEN 系统 SHALL 正常工作（注：Safari对系统音频支持有限）
7. IF 在Safari浏览器上使用 AND 用户选择系统声音 THEN 系统 SHALL 显示提示"Safari浏览器不支持系统声音录制，仅支持麦克风录音"

## 技术约束

1. 录音功能必须使用浏览器原生的 MediaRecorder API
2. 音频格式应优先使用 WebM（Opus编码），备选 WAV 格式
3. 录音文件大小限制与现有文件上传限制保持一致（50MB）
4. 录音时长上限为 2 小时
5. 必须支持多音频流混音（使用 Web Audio API）
6. 前端不应存储完整的录音数据，录音完成后立即上传到后端

## 非功能性需求

1. **性能**：录音过程中CPU占用率应低于30%，不影响其他应用运行
2. **可靠性**：录音过程中如果发生错误，应尽可能保存已录制的内容
3. **安全性**：录音数据传输必须使用HTTPS加密
4. **可访问性**：所有按钮和控件应支持键盘操作
5. **响应性**：录音控制操作（开始、停止、暂停）的响应时间应小于200ms

## 依赖关系

1. 依赖现有的文件上传API（/api/upload）
2. 依赖现有的进度查询机制（/api/progress/:fileId）
3. 依赖现有的会议纪要生成流程
4. 需要浏览器支持 MediaRecorder API 和 Web Audio API
5. 需要用户授予麦克风和屏幕共享权限

## 未来扩展

1. 支持录音暂停和恢复功能
2. 支持录音过程中实时转录（流式转录）
3. 支持录音质量选择（高、中、低）
4. 支持录音文件本地保存和管理
5. 支持多人协同录音（多个设备同时录音并合并）
